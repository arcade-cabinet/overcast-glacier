name: CI

on:
  push:
    branches: [main, release/1.0]
  pull_request:
    branches: [main, release/1.0]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Native App Checks (Release 1.0 Focus)
  native-checks:
    name: Native App (Typecheck & Lint)
    runs-on: ubuntu-latest
on:
  push:
    branches: [main, release/1.0]
  pull_request:
    branches: [main, release/1.0]
  workflow_dispatch:
    inputs:
      target:
        description: 'Target platform (native or web)'
        required: false
        default: 'native'
        type: choice
        options:
          - native
          - web
    defaults:
      run:
        working-directory: ./apps/native
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Using npm for native as currently configured
      - name: Install Native Dependencies
        run: npm install

      - name: TypeScript Check (Native)
        run: npx tsc --noEmit

      # Using pnpm for root/biome as currently configured
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Root Dependencies (for Biome)
        run: |
          cd ../..
          pnpm install --frozen-lockfile

      - name: Lint Native App
        run: |
          cd ../..
          pnpm exec biome check apps/native

  # Web App Checks (Deprecated/Maintenance only)
  # Only runs if changes detected in web-specific files AND not just native files
  web-checks:
    name: Web App (Legacy)
    runs-on: ubuntu-latest
    # Simple path filter strategy:
    # If we could use 'paths' here easily, we would.
    # Instead, we rely on the fact that this job is now optional/low-priority.
    # For DRYness, we kept the robust logic in 'native-checks'.
    # This job preserves the old logic but is generally skipped for native-only PRs via manual control or future path filters if needed.
    if: false # DISABLED for Release 1.0 focus unless manually re-enabled or critical web patch needed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Biome linter (Web)
        run: pnpm exec biome check .

      - name: Run Unit Tests
        run: pnpm run test
